<!doctype html>
<html lang="mk">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Operations Dashboard v2</title>
  <style>
    :root{
      --bg:#ffffff; --text:#111827; --muted:#6b7280;
      --card:#ffffff; --border:#e5e7eb; --accent:#2563eb;
      --thead:#f8fafc; --hover:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Arial; color:var(--text); background:var(--bg)}
    header{position:sticky; top:0; background:#fff; border-bottom:1px solid var(--border); padding:20px 24px; z-index:10}
    h1{margin:0; font-size:24px}
    .muted{color:var(--muted); font-size:13px; margin-top:6px}

    main{padding:24px; display:grid; gap:24px}
    .grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(320px,1fr)); gap:24px}

    .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px}
    .card h2{margin:0 0 10px 0; font-size:18px}

    .placeholder{
      border:2px dashed var(--border); border-radius:10px; padding:16px; color:var(--muted); font-size:14px;
      background:#fff;
    }

    .table-wrap{overflow:auto; background:#fff; border:1px solid var(--border); border-radius:12px}
    table{width:100%; border-collapse:collapse; font-size:14px}
    thead th{position:sticky; top:0; background:var(--thead); border-bottom:1px solid var(--border)}
    th,td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left}
    tr:hover td{background:var(--hover)}
    a{color:#0ea5e9; text-decoration:none} a:hover{text-decoration:underline}
    footer{padding:16px 24px; border-top:1px solid var(--border); color:var(--muted); margin-top:8px}

    .plotly-graph-div{width:100% !important; height:auto !important}
    .note{font-size:12px; color:var(--muted); margin-top:6px}
  </style>
</head>
<body>
  <header>
    <h1>Operations Dashboard v2</h1>
    <div class="muted">Генерирано: {{ generated_at }}</div>
  </header>

  <main>
    <!-- Графици -->
    <section class="grid">
      <article class="card">
        <h2>Распределба на €/m² по категорија</h2>
        {% if plot_dist and ('<' in plot_dist) %}
          {{ plot_dist | safe }}
        {% else %}
          <div class="placeholder">Нема график за сега. Пушти <em>crawl</em> за свежи податоци.</div>
        {% endif %}
      </article>

      <article class="card">
        <h2>Површина vs Цена</h2>
        {% if plot_scatter and ('<' in plot_scatter) %}
          {{ plot_scatter | safe }}
        {% else %}
          <div class="placeholder">Нема график за сега. Пушти <em>crawl</em> за свежи податоци.</div>
        {% endif %}
      </article>

      <article class="card">
        <h2>Топ општини по медијана €/m²</h2>
        {% if plot_top_munis and ('<' in plot_top_munis) %}
          {{ plot_top_munis | safe }}
        {% else %}
          <div class="placeholder">Нема график за сега. Пушти <em>crawl</em> за свежи податоци.</div>
        {% endif %}
      </article>

      <article class="card">
        <h2>Обем на огласи по старост</h2>
        {% if plot_volume and ('<' in plot_volume) %}
          {{ plot_volume | safe }}
        {% else %}
          <div class="placeholder">Нема график за сега. Пушти <em>crawl</em> за свежи податоци.</div>
        {% endif %}
      </article>
    </section>

    <!-- Табела -->
    <section class="card">
      <h2>Топ записи (според score/свежина)</h2>
      {% if rows and columns %}
        <div class="table-wrap">
          <table id="data">
            <thead>
              <tr>{% for c in columns %}<th>{{ c }}</th>{% endfor %}</tr>
            </thead>
            <tbody>
              {% for r in rows %}
              <tr>
                {% for c in columns %}
                  <td>
                    {% if c == 'url' and r[c] %}
                      <a href="{{ r[c] }}" target="_blank" rel="noopener">{{ r[c] }}</a>
                    {% else %}
                      {{ r[c] }}
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="note">Совет: клик на headер за локално сортирање.</div>
      {% else %}
        <div class="placeholder">Нема податоци за табела. Пушти <code>python main_v2.py crawl</code> па <code>report</code>.</div>
      {% endif %}
    </section>
  </main>

  <footer>
    <small>© {{ generated_at.split(' ')[0] }} • Автоматски извештај</small>
  </footer>

  <!-- Едноставно локално сортирање по клик на колона -->
  <script>
    (function(){
      const t = document.getElementById('data');
      if(!t) return;
      const ths = t.querySelectorAll('th');
      const tbody = t.querySelector('tbody');
      ths.forEach((th, i)=>{
        th.style.cursor='pointer';
        th.addEventListener('click', ()=>{
          const rows = Array.from(tbody.querySelectorAll('tr'));
          const dir = th.dataset.dir === 'asc' ? 'desc' : 'asc';
          th.dataset.dir = dir;
          rows.sort((a,b)=>{
            const A = a.children[i].innerText.trim();
            const B = b.children[i].innerText.trim();
            const na = parseFloat(A.replace(/[^\d.-]/g,'')),
                  nb = parseFloat(B.replace(/[^\d.-]/g,''));
            if(!isNaN(na) && !isNaN(nb)) return dir==='asc' ? na-nb : nb-na;
            return dir==='asc' ? A.localeCompare(B) : B.localeCompare(A);
          });
          rows.forEach(r=>tbody.appendChild(r));
        });
      });
    })();
  </script>
</body>
</html>
